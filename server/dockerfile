FROM node:22-alpine

WORKDIR /app

# Install build tools dan Python untuk build native modules
RUN apk add --no-cache --virtual .build-deps \
    build-base \
    python3 \
    make \
    g++

# Salin file dependency
COPY package.json yarn.lock ./

# Install semua dependency (termasuk devDependencies untuk build)
RUN yarn install --frozen-lockfile

# Salin semua source code
COPY . .

# Build (misal TypeScript atau transpile lainnya)
RUN yarn build

# Hapus devDependencies dan tools build
RUN yarn install --production=true --frozen-lockfile \
    && yarn cache clean \
    && apk del .build-deps \
    && rm -rf /var/cache/apk/*

# Set environment
ENV NODE_ENV=production
ENV PORT=3000

# Buka port 3000
EXPOSE 3000

# Jalankan sebagai user node (default sudah ada di image Node.js Alpine)
USER node

# Perintah start
CMD ["yarn", "start:prod"]
